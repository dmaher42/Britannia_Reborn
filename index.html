<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Project: Britannia Reborn — Prototype</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="root">
    <canvas id="sky"></canvas>
    <canvas id="back"></canvas>
  <canvas id="game" tabindex="0"></canvas>
  <canvas id="fx"></canvas>
  <div id="focusOverlay">Click to refocus · WASD/Arrows to move · Shift+Arrows to look</div>
    <svg class="gridOverlay" id="gridOverlay"></svg>
    <div class="vignette"></div>

    <div class="hud">
      <div class="topbar">
        <div class="left">
          <button class="btn" id="btnTalk">Talk</button>
          <button class="btn" id="btnCombat">Start Combat</button>
          <button class="btn" id="btnCast">Cast: Fire Dart</button>
          <button class="btn" id="btnEndTurn" disabled>End Turn</button>
        </div>
          <div class="right">
            <div class="pill" id="terrainPill">Terrain: Road</div>
          </div>
        </div>

      <div class="panel">
        <div class="card glow" id="partyCard">
          <h3>Party</h3>
          <div id="partyList"></div>
        </div>

        <div class="card" id="packCard">
          <h3>Shared Inventory</h3>
          <div class="row"><div>Equipped (per-char)</div><div id="equipRule">equip ≤ STR</div></div>
          <div class="row"><div>Backpack (per-char)</div><div id="packRule">pack ≤ STR×2</div></div>
          <div class="row"><div>Reagents</div><div id="reagents">-</div></div>
          <div class="row"><div>Total Weight</div><div id="totalWeight">-</div></div>
          <div class="row"><div>Gold</div><div id="gold">125</div></div>
          <div class="row"><button class="btn" id="btnAddLoot">Add Demo Loot</button></div>
        </div>
      </div>
    </div>

    <div class="dialogue" id="dialogue"></div>
    <div class="toast" id="toast" style="display:none"></div>
    <div class="watermark">Local ES‑Modules Prototype — AI optional via server</div>
  </div>

  <script type="module" src="./main.js?v=" id="game-script"></script>
  <script>
    document.getElementById('game-script').src += Date.now();
  </script>

  <script type="module">
    // Dev escape hatch: disable & unregister SW with ?dev=1
    const params = new URLSearchParams(location.search);
    const isDev = params.get('dev') === '1';
    const buildTag = String(Date.now());

    if ('serviceWorker' in navigator) {
      if (isDev) {
        navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
        console.info('[SW] Unregistered for dev (use ?dev=1).');
      } else {
        navigator.serviceWorker.register('./service-worker.js?v=' + buildTag).then(reg => {
          if (reg.waiting) reg.waiting.postMessage('SKIP_WAITING');
          reg.addEventListener('updatefound', () => {
            const sw = reg.installing;
            if (!sw) return;
            sw.addEventListener('statechange', () => {
              if (sw.state === 'installed' && navigator.serviceWorker.controller) {
                sw.postMessage('SKIP_WAITING');
              }
            });
          });
        });

        navigator.serviceWorker.addEventListener('controllerchange', () => {
          location.reload();
        });
      }
    }

    const cvs = document.getElementById('game');
    const overlay = document.getElementById('focusOverlay');
    window.addEventListener('load', () => cvs.focus());
    ['pointerdown','mousedown','touchstart'].forEach(ev =>
      cvs.addEventListener(ev, () => cvs.focus(), { passive: true })
    );
    cvs.addEventListener('focus', () => { overlay.style.display = 'none'; });
    cvs.addEventListener('blur', () => { overlay.style.display = 'block'; });
    window.addEventListener('keydown', (e) => {
      const block = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key) || (e.key.length === 1);
      if (block) e.preventDefault();
    }, { passive: false });
  </script>

</body>
</html>
